image: golang:1.9
options:
  docker: true
pipelines:
  default:
  - step:
      name: "Compile & Test"
      caches:
      - dist
      artifacts:
      - ./dist/**
      - ./dist/*.tar.gz
      script:
      - go version
      - export ORIGINAL_DIRECTORY=$(pwd)
      - export DESIRED_DIRECTORY="${GOPATH}/src/github/dadleyy/gendry"
      - mkdir -p $DESIRED_DIRECTORY
      - pushd $DESIRED_DIRECTORY/..
      - mv $ORIGINAL_DIRECTORY/* $DESIRED_DIRECTORY
      - pushd $DESIRED_DIRECTORY
      - make EXE=./dist/gendry/bin/gendry
      - make test
      - tar -czvf ./dist/gendry-$(go env GOOS)-$(go env GOARCH).tar.gz -C ./dist/gendry ./
      - ls -lah ./dist
      - popd
      - popd
      - echo $BITBUCKET_CLONE_DIR
      - echo $(pwd)
      - mkdir -p ./dist
      - cp $DESIRED_DIRECTORY/dist/gendry-$(go env GOOS)-$(go env GOARCH).tar.gz ./dist
      - ls -lah ./dist
  - step:
      name: "Build Image"
      caches:
      - dist
      script:
      - ls -lah
      - cp ./dist/gendry-$(go env GOOS)-$(go env GOARCH).tar.gz ./gendry.tar.gz
      - ls -lah
      - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker build -t dadleyy/gendry:$BITBUCKET_COMMIT -f ./auto/bitbucket/Dockerfile .
      - docker push dadleyy/gendry:$BITBUCKET_COMMIT
definitions:
  caches:
    dist: dist
